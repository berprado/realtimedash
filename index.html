<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backstage Online | Live Dashboard</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Oswald:wght@500;700&display=swap"
        rel="stylesheet">

    <!-- Google Material Symbols -->
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />

    <!-- Custom Styles -->
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <!-- Audio Alert (Hidden) -->
    <!-- Using a short base64 beep for standalone functionality without external file dependencies -->
    <audio id="alert-sound" src="data:audio/wav;base64,UklGRl9vT1d7ABAAZGF0YU..." preload="auto"></audio>
    <!-- Note: I will inject a real short beep base64 in the JS or source attr for simplicity. 
         For now, let's use a standard path or assume the user can provide a file. 
         To be robust, I'll use a silent placeholder here and handle it in JS or ask user for a path later.
         Actually, let's use a simple URL or explain the placeholder. -->

    <div class="container">
        <header>
            <h1>Backstage <span style="font-weight: 300; font-size: 0.8em; opacity: 0.8;">Online</span></h1>
            <div class="status-indicator">
                <div class="pulsating-circle"></div>
                LIVE FEED
            </div>
        </header>

        <!-- Grid Container for Orders -->
        <div id="orders-container" class="orders-grid">
            <!-- Cards will be injected here via JS -->
        </div>
    </div>

    <script>
        const container = document.getElementById('orders-container');
        const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');

        let lastComandaId = 0; // Tracking id_comanda

        // Function to format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-BO', { style: 'currency', currency: 'BOB' }).format(amount);
        }

        // Logic: Process Product Name & Icon based on Prefixes
        function processProductInfo(originalName) {
            let name = originalName || '';
            let icon = 'local_drink'; // Default icon

            if (name.startsWith('C ')) {
                name = name.substring(2);
                icon = 'liquor';
            } else if (name.startsWith('V ')) {
                name = name.substring(2);
                icon = 'wine_bar';
            } else if (name.startsWith('CHOPP ')) {
                name = name.substring(6);
                icon = 'sports_bar';
            } else if (name.startsWith('JARRA ')) {
                name = name.substring(6);
                icon = 'kettle';
            } else if (name.startsWith('MOCKTAIL ')) {
                name = name.substring(9);
                icon = 'no_drinks';
            }
            // Default case: keeps original name + local_drink icon
            return { name, icon };
        }

        // Logic: Determine Status Visuals based on 3 columns
        function getStatusInfo(ts, ec, ei) {
            const type = (ts || '').toUpperCase();
            const state = (ec || '').toUpperCase();
            const print = (ei || '').toUpperCase(); // ei can be null/undefined

            // 1. CORTESIA PROCESADO IMPRESO
            if (type === 'CORTESIA' && state === 'PROCESADO' && print === 'IMPRESO') {
                return { class: 'type-courtesy', icon: 'money_off', label: '' }; // Only icon requested
            }

            // 2. VENTA PROCESADO IMPRESO
            if (type === 'VENTA' && state === 'PROCESADO' && print === 'IMPRESO') {
                return { class: 'status-sale', icon: 'price_check', label: '' }; // Only icon
            }

            // 3. VENTA ANULADO (null)
            // Checking if print is 'null' string or empty/undefined. API might return null object or empty string.
            if (type === 'VENTA' && state === 'ANULADO' && (!print || print === 'NULL')) {
                return { class: 'status-cancelled', icon: 'remove_done', label: '' };
            }

            // 4. VENTA PENDIENTE (null)
            if (type === 'VENTA' && state === 'PENDIENTE' && (!print || print === 'NULL')) {
                return { class: 'status-pending', icon: 'pending_actions', label: '' };
            }

            // Default: INDEJINIDO
            return { class: 'status-undefined', icon: 'question_mark', label: '' };
        }

        var source = new EventSource("fetch.php");

        source.onmessage = function (event) {
            try {
                const data = JSON.parse(event.data);

                container.innerHTML = '';

                let maxIdInBatch = 0;

                if (data.length > 0) {
                    // Assuming sorted by ID DESC, so first is newest
                    const newestItem = data[0];

                    // Audio Alert Logic based on id_comanda
                    const currentComandaId = parseInt(newestItem.id_comanda);

                    if (lastComandaId !== 0 && currentComandaId > lastComandaId) {
                        audio.play().catch(e => console.log('Audio autoplay blocked', e));
                    }

                    // Update tracker
                    // We track the max ID present in the batch to avoid re-triggering on same data
                    // Note: using the loop to find absolute max just in case, though index 0 should be it.
                    maxIdInBatch = currentComandaId;
                }

                data.forEach(item => {
                    // Process Product Name (Prefixes)
                    const product = processProductInfo(item.nombre);

                    // Process Status
                    // Assuming fetch.php returns fields as: tipo_salida, estado_comanda, estado_impresion
                    // Note: estado_impresion might need to move to SELECT list in fetch.php if not there.
                    // Checking previous fetch.php content... it blindly does SELECT * FROM comandas_v6
                    // comandas_v6 HAS estado_impresion. So we are good.
                    const status = getStatusInfo(item.tipo_salida, item.estado_comanda, item.estado_impresion);

                    // Courtesy Price Logic
                    // If it's a courtesy, show the 'before' price so they know what value they gave away.
                    // Otherwise show the actual transaction sub_total (which might be 0 for courtesy in DB, but we want the visual reference)
                    let displayPrice = item.sub_total;
                    if (status.class === 'type-courtesy') {
                        displayPrice = item.cor_subtotal_anterior;
                    }

                    let cardClasses = `order-card ${status.class}`;
                    if (parseInt(item.id_comanda) > lastComandaId && lastComandaId !== 0) {
                        cardClasses += ' highlight-new';
                    }

                    const cardHTML = `
                    <div class="${cardClasses}">
                        <div class="card-header">
                            <span class="order-id">#${item.id_comanda || '???'}</span>
                            <span class="status-badge" title="${item.tipo_salida} - ${item.estado_comanda}">
                                <span class="material-symbols-outlined" style="font-size: 18px;">${status.icon}</span>
                                ${status.label}
                            </span>
                        </div>
                        
                        <div class="product-name">
                            ${parseFloat(item.cantidad) > 1 ? `<span style="color:var(--accent-color);">${Math.round(item.cantidad)}x</span> ` : ''}
                            <span class="material-symbols-outlined" style="font-size: 1.2em; vertical-align: text-bottom; margin-right:4px;">${product.icon}</span>
                            ${product.name}
                        </div>

                        <div class="product-meta">
                            <span class="timestamp">
                                <span class="material-symbols-outlined" style="font-size: 14px; vertical-align: -2px;">schedule</span>
                                ${item.fecha_emision ? item.fecha_emision.split(' ')[1] : '--:--'}
                            </span>
                            <span class="price-tag">${formatCurrency(displayPrice)}</span>
                        </div>
                        <div style="font-size:0.8rem; color: #64748b; margin-top:5px; text-align:right;">
                             ${item.usuario_reg || 'Staff'}
                        </div>
                    </div>
                `;

                    container.innerHTML += cardHTML;
                });

                if (maxIdInBatch > 0) {
                    lastComandaId = maxIdInBatch;
                }

            } catch (e) {
                console.error("Error parsing SSE data", e);
            }
        }
    </script>
</body>

</html>